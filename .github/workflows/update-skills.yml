name: Update Skills

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-skills:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install skills-pkg
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ARCH=$(uname -m)
          case "$ARCH" in
            x86_64)  ARCH="x86_64" ;;
            aarch64) ARCH="arm64" ;;
            armv7l)  ARCH="armv7" ;;
          esac
          gh release download \
            --repo mazrean/skills-pkg \
            --pattern "skills-pkg_Linux_${ARCH}.tar.gz" \
            --dir /tmp/skills-pkg-dl
          tar -xzf "/tmp/skills-pkg-dl/skills-pkg_Linux_${ARCH}.tar.gz" \
            -C /tmp/skills-pkg-dl
          sudo install -m 755 /tmp/skills-pkg-dl/skills-pkg /usr/local/bin/skills-pkg

      - name: Install skills
        run: skills-pkg install

      - name: Detect updates (dry-run)
        id: detect
        run: |
          skills-pkg update --dry-run --output json > dry-run-output.json
          UPDATE_SKILLS=$(jq -c '[.updates[] | select(.has_update == true) | .skill_name]' dry-run-output.json)
          echo "skills=$UPDATE_SKILLS" >> "$GITHUB_OUTPUT"

      - name: Update skills with worktrees
        if: steps.detect.outputs.skills != '[]'
        run: |
          set -euo pipefail
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          pids=()
          for skill in $(echo '${{ steps.detect.outputs.skills }}' | jq -r '.[]'); do
            branch="update-skill/${skill}"
            git worktree add "worktrees/${skill}" -B "${branch}"
            (
              set -euo pipefail
              cd "worktrees/${skill}"
              skills-pkg install "${skill}"
              skills-pkg update --dry-run --output json "${skill}" > "/tmp/dry-run-${skill}.json"
              skills-pkg update "${skill}"
              git add -A
              if git diff --cached --quiet; then
                echo "No changes for ${skill}, skipping commit"
                exit 0
              fi
              git commit -m "chore(skills): update ${skill}"
              git push --force-with-lease origin "${branch}"
            ) &
            pids+=($!)
          done

          failed=0
          for pid in "${pids[@]}"; do
            wait "$pid" || failed=1
          done
          if [ "${failed}" -ne 0 ]; then
            echo "One or more skill updates failed" >&2
            exit 1
          fi

      - name: Create PRs
        if: steps.detect.outputs.skills != '[]'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for skill in $(echo '${{ steps.detect.outputs.skills }}' | jq -r '.[]'); do
            branch="update-skill/${skill}"
            existing_pr=$(gh pr list --head "${branch}" --json number --jq '.[0].number' 2>/dev/null || echo "")
            if [ -n "$existing_pr" ]; then
              echo "PR already exists for ${skill}: #${existing_pr}, skipping"
              continue
            fi
            added_files=$(jq -r '
              .updates[].file_diffs[]? |
              select(.status == "added") | "**Added:** `\(.path)`"
            ' "/tmp/dry-run-${skill}.json")
            removed_files=$(jq -r '
              .updates[].file_diffs[]? |
              select(.status == "removed") | "**Removed:** `\(.path)`"
            ' "/tmp/dry-run-${skill}.json")
            diff_output=$(jq -r '
              .updates[].file_diffs[]? |
              select(.patch != null and .patch != "") |
              "diff --git a/\(.path) b/\(.path)\n--- a/\(.path)\n+++ b/\(.path)\n\(.patch)"
            ' "/tmp/dry-run-${skill}.json")
            body_file=$(mktemp)
            {
              printf 'Automated skill update for %s.\n\n## Changes\n\n' "${skill}"
              if [ -z "${added_files}" ] && [ -z "${removed_files}" ] && [ -z "${diff_output}" ]; then
                printf 'No Skill Difference\n'
              else
                [ -n "${added_files}" ] && printf '%s\n' "${added_files}"
                [ -n "${removed_files}" ] && printf '%s\n' "${removed_files}"
                if [ -n "${added_files}" ] || [ -n "${removed_files}" ]; then
                  printf '\n'
                fi
                [ -n "${diff_output}" ] && printf '```diff\n%s\n```\n' "${diff_output}"
              fi
            } > "${body_file}"
            gh pr create \
              --title "chore(skills): update ${skill}" \
              --body-file "${body_file}" \
              --head "${branch}" \
              --label "dependencies"
            rm -f "${body_file}"
          done
